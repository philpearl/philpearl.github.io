<!DOCTYPE html>
<html lang="en-gb" dir="ltr">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>JSON and embedding &middot; EnTitled</title>
  <meta name="description" content="Prefer composition over inheritance, but with JSON both of them can get in the sea." />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://philpearl.github.io/css/main.min.css" />
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-64013694-2', 'auto');
	
	ga('send', 'pageview');
}
</script>

  
</head>
  <body class="single-body">
    <nav class="nav-bar side-padding">
  <h1 class="nav-header"><a href="https://philpearl.github.io/" class="nav-text">EnTitled</a></h1>
  <div class="hamburger-menu">
    <button onclick="hamburgerMenuPressed.call(this)" aria-haspopup="true" aria-expanded="false" aria-controls="menu" aria-label="Menu">
      <span></span>
      <span></span>
    </button>
    <ul id="menu" class="hamburger-menu-overlay">
      <li><a href="https://philpearl.github.io/" class="hamburger-menu-overlay-link">Home</a></li>
      <li><a href="https://philpearl.github.io/categories/benchmark" class="hamburger-menu-overlay-link">Benchmark</a></li><li><a href="https://philpearl.github.io/categories/go" class="hamburger-menu-overlay-link">Go</a></li><li><a href="https://philpearl.github.io/categories/json" class="hamburger-menu-overlay-link">Json</a></li><li><a href="https://philpearl.github.io/categories/linux" class="hamburger-menu-overlay-link">Linux</a></li><li><a href="https://philpearl.github.io/categories/memoryleak" class="hamburger-menu-overlay-link">Memoryleak</a></li><li><a href="https://philpearl.github.io/categories/performance" class="hamburger-menu-overlay-link">Performance</a></li><li><a href="https://philpearl.github.io/categories/programming" class="hamburger-menu-overlay-link">Programming</a></li>
    </ul>
  </div>
</nav>
    <main class="content side-text-padding">
      <article class="post dropcase">
        <header class="post-header">
        	<h1 class="post-title">JSON and embedding</h1>
          <p class="post-date">Posted <time datetime="2019-03-10">Mar 10, 2019</time></p>
        </header>
        
        <picture class="post-figure">
            
            <source srcset="https://philpearl.github.io/post/sea.jpg">
          <img src="https://philpearl.github.io/post/sea.jpg" alt="The sea">
        </picture>
        
        <p>Did everyone else already know this? Why didn&rsquo;t you tell me? I got very confused the other day with some apparently simple JSON encoding. Here&rsquo;s a simplified version, showing marshalling a struct with an <a href="https://golang.org/doc/effective_go.html#embedding">embedded struct</a> inside it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;encoding/json&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Inner</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">InnerField</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;inner_field&#34;`</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Outer</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Inner</span>
	<span style="color:#a6e22e">OuterField</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;outer_field&#34;`</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">val</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Outer</span>{
		<span style="color:#a6e22e">Inner</span>: <span style="color:#a6e22e">Inner</span> {
			<span style="color:#a6e22e">InnerField</span>: <span style="color:#e6db74">&#34;inner&#34;</span>,
		},
		<span style="color:#a6e22e">OuterField</span>: <span style="color:#e6db74">&#34;outer&#34;</span>,
	}
	<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">MarshalIndent</span>(<span style="color:#a6e22e">val</span>, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">&#34;  &#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(string(<span style="color:#a6e22e">data</span>))
}</code></pre></div>
<p>Output is as follows.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;inner_field&#34;</span>: <span style="color:#e6db74">&#34;inner&#34;</span>,
  <span style="color:#f92672">&#34;outer_field&#34;</span>: <span style="color:#e6db74">&#34;outer&#34;</span>
}</code></pre></div>
<p>Now, let&rsquo;s say we want to implement a custom marshaller for Inner. This is a silly example - in the real world I was trying out <a href="https://github.com/mailru/easyjson">easyjson</a> looking for some performance gains.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">i</span> <span style="color:#a6e22e">Inner</span>) <span style="color:#a6e22e">MarshalJSON</span>() ([]<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">return</span> []byte(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">`{&#34;innnnnnerrFeild&#34;: %q}`</span>, <span style="color:#a6e22e">i</span>.<span style="color:#a6e22e">InnerField</span>)), <span style="color:#66d9ef">nil</span>
}</code></pre></div>
<p>What would you expect the output to be? I know I hoped it would be as follows.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;innnnnnerrFeild&#34;</span>: <span style="color:#e6db74">&#34;inner&#34;</span>,
  <span style="color:#f92672">&#34;outer_field&#34;</span>: <span style="color:#e6db74">&#34;outer&#34;</span>
}</code></pre></div>
<p>But it turns out the output is as follows.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;innnnnnerrFeild&#34;</span>: <span style="color:#e6db74">&#34;inner&#34;</span>
}</code></pre></div>
<p>Why is that? Well, <code>Inner</code> implements <code>json.Marshaller</code>, and because of embedding, so does <code>Outer</code>. So when marshalling <code>Outer</code>, the json library just calls the <code>Inner</code> marshaller. So the entire JSON for <code>Outer</code> is determined by <code>Inner</code>&rsquo;s <code>MarshalJSON</code>. Entirely what you&rsquo;d expect when you think about it, but completely surprising for me at least in this situation.</p>

<p>So, be extremely careful about using struct embedding with structs that are marshalled or unmarshalled.</p>

<p>How can we fix this? Well, if we add another field to <code>Outer</code> that implements <code>json.Marshaller</code>, then <code>Outer</code> will no-longer implement <code>json.Marshaller</code> as the implementation will be ambiguous. We can use <code>struct{}</code> for this and it will take no room!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">marshalblock</span> <span style="color:#66d9ef">struct</span>{}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">marshalblock</span>) <span style="color:#a6e22e">MarshalJSON</span>() ([]<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">error</span>) { <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span> }

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Outer</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">marshalblock</span>
	<span style="color:#a6e22e">Inner</span>
	<span style="color:#a6e22e">OuterField</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;outer_field&#34;`</span>
}</code></pre></div>
<p>Here&rsquo;s the output after this modification.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;inner_field&#34;</span>: <span style="color:#e6db74">&#34;inner&#34;</span>,
  <span style="color:#f92672">&#34;outer_field&#34;</span>: <span style="color:#e6db74">&#34;outer&#34;</span>
}</code></pre></div>
<p>Unfortunately this also stops json from using the marshaller on <code>Inner</code>. Which I think is a bug.</p>

      </article>
      
    </main>
    <nav class="end-nav side-padding">
      
      <a ontouchstart="cardPressed.call(this)" ontouchend="cardReleased.call(this)" ontouchmove="cardReleased.call(this)" 
  href="https://philpearl.github.io/post/why_of_go_strings/" class="card blog-card" rel="bookmark" >
    
    <div class="card-img-container">
      <p class="card-img-overlay">Next Article</p>
      <picture>
        
        <source srcset="https://philpearl.github.io/post/strings.jpeg">
        <img src="https://philpearl.github.io/post/strings.jpeg" class="card-img" alt="a ball of wool">
      </picture>
    </div>
    
  <article class="card-body">
    <h2 class="card-title">The why of Go strings</h2>
    <p class="card-text">A story about strings that might even be true.</p>
    <div class="card-subtext muted-text">
      <p>Posted <time datetime="2019-03-10 310:00">Mar 10, 2019</time></p>
      <p>#go #programming </p>
    </div>
  </article>
</a>
      
      <a ontouchstart="cardPressed.call(this)" ontouchend="cardReleased.call(this)" ontouchmove="cardReleased.call(this)" 
  href="https://philpearl.github.io/" class="card home-card" style="background-image: url( https://philpearl.github.io/img/grey-cloud.jpg )" rel="bookmark" >
  Home
</a>
    </nav>
    <footer>
    
</footer>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>
<script src="https://philpearl.github.io/js/core.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>
  </body>
</html>