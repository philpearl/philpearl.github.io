<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-gb" lang="en-gb">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>JSON and embedding</title>
  <meta name="description" content="Prefer composition over inheritance, but with JSON both of them can get in the sea."/> 

  <style>
  body{
    font-family: "PT Sans", Helvetica, Arial, sans-serif;
    font-size: 1.2em;
    line-height: 1.5em;
  }
  .description {
    font-size: 1.25em;
    font-weight: 300;
  }
  img {
    max-width: 100%;
  }
  main {
    margin: auto;
    width: 60%;
    padding: 0 1em;
  }
  footer {
    margin: auto;
    width: 60%;
    padding: 0 1em;
    color: gray;
    font-size: 0.8em;
  }
  </style>
</head>
<body>
    <main>
        <div class="post">
            
            <figure>
                <img src="/post/sea.jpg" alt="A lovely picture of the sea" />
                <figcaption>A lovely picture of the sea</figcaption> 
            </figure>
            

            <h1>JSON and embedding</h1>
            <p class="description" >Prefer composition over inheritance, but with JSON both of them can get in the sea.</p> 

            <p>Did everyone else already know this? Why didn't you tell me? I got very confused the other day with some apparently simple JSON encoding. Here's a simplified version, showing marshalling a struct with an <a href="https://golang.org/doc/effective_go.html#embedding">embedded struct</a> inside it.</p>
<pre><code class="language-go">package main

import (
	&quot;encoding/json&quot;
	&quot;fmt&quot;
)

type Inner struct {
	InnerField string `json:&quot;inner_field&quot;`
}

type Outer struct {
	Inner
	OuterField string `json:&quot;outer_field&quot;`
}

func main() {
	val := Outer{
		Inner: Inner {
			InnerField: &quot;inner&quot;,
		},
		OuterField: &quot;outer&quot;,
	}
	data, err := json.MarshalIndent(val, &quot;&quot;, &quot;  &quot;)
	if err != nil {
		fmt.Println(err)
		return
	}
	fmt.Println(string(data))
}
</code></pre>
<p>Output is as follows.</p>
<pre><code class="language-json">{
  &quot;inner_field&quot;: &quot;inner&quot;,
  &quot;outer_field&quot;: &quot;outer&quot;
}
</code></pre>
<p>Now, let's say we want to implement a custom marshaller for Inner. This is a silly example - in the real world I was trying out <a href="https://github.com/mailru/easyjson">easyjson</a> looking for some performance gains.</p>
<pre><code class="language-go">func (i Inner) MarshalJSON() ([]byte, error) {
	return []byte(fmt.Sprintf(`{&quot;innnnnnerrFeild&quot;: %q}`, i.InnerField)), nil
}
</code></pre>
<p>What would you expect the output to be? I know I hoped it would be as follows.</p>
<pre><code class="language-json">{
  &quot;innnnnnerrFeild&quot;: &quot;inner&quot;,
  &quot;outer_field&quot;: &quot;outer&quot;
}
</code></pre>
<p>But it turns out the output is as follows.</p>
<pre><code class="language-json">{
  &quot;innnnnnerrFeild&quot;: &quot;inner&quot;
}
</code></pre>
<p>Why is that? Well, <code>Inner</code> implements <code>json.Marshaller</code>, and because of embedding, so does <code>Outer</code>. So when marshalling <code>Outer</code>, the json library just calls the <code>Inner</code> marshaller. So the entire JSON for <code>Outer</code> is determined by <code>Inner</code>'s <code>MarshalJSON</code>. Entirely what you'd expect when you think about it, but completely surprising for me at least in this situation.</p>
<p>So, be extremely careful about using struct embedding with structs that are marshalled or unmarshalled.</p>
<p>How can we fix this? Well, if we add another field to <code>Outer</code> that implements <code>json.Marshaller</code>, then <code>Outer</code> will no-longer implement <code>json.Marshaller</code> as the implementation will be ambiguous. We can use <code>struct{}</code> for this and it will take no room!</p>
<pre><code class="language-go">type marshalblock struct{}
func (marshalblock) MarshalJSON() ([]byte, error) { return nil, nil }

type Outer struct {
	marshalblock
	Inner
	OuterField string `json:&quot;outer_field&quot;`
}
</code></pre>
<p>Here's the output after this modification.</p>
<pre><code class="language-json">{
  &quot;inner_field&quot;: &quot;inner&quot;,
  &quot;outer_field&quot;: &quot;outer&quot;
}
</code></pre>
<p>Unfortunately this also stops json from using the marshaller on <code>Inner</code>. Which I think is a bug - but perhaps just another hint that embedding and JSON don't mix.</p>

        </div>
    </main>
    <footer>
        <p>Â© 2016 - 2023 Phil Pearl. All rights reserved.</p>
    </footer>
</body>